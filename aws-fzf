#!/usr/bin/env bash

[ -z "$DEBUG" ] || set -x

set -eo pipefail

_aws_fzf_source_dir=$(dirname "${BASH_SOURCE[0]}")

# Source command implementations
source "$_aws_fzf_source_dir/scripts/aws_secret.sh"
source "$_aws_fzf_source_dir/scripts/aws_param.sh"
source "$_aws_fzf_source_dir/scripts/aws_lambda.sh"
source "$_aws_fzf_source_dir/scripts/aws_log.sh"
source "$_aws_fzf_source_dir/scripts/aws_ecs.sh"
source "$_aws_fzf_source_dir/scripts/aws_s3.sh"
source "$_aws_fzf_source_dir/scripts/aws_rds.sh"
source "$_aws_fzf_source_dir/scripts/aws_dsql.sh"
source "$_aws_fzf_source_dir/scripts/aws_dynamodb.sh"
source "$_aws_fzf_source_dir/scripts/aws_sso.sh"

# _show_root_help()
#
# Display help information for aws fzf
#
# DESCRIPTION:
#   Prints the main help documentation for the aws fzf tool, including
#   usage instructions, available commands (matching AWS CLI structure),
#   and examples showing AWS CLI parity.
#
# PARAMETERS:
#   None
#
# RETURNS:
#   0 - Always returns success
#
# OUTPUT:
#   Writes help text to stdout
#
_show_root_help() {
    cat <<'EOF'
aws fzf - Interactive fuzzy finder for AWS resources

DESCRIPTION:
    aws fzf provides an interactive interface for browsing AWS resources
    using fzf (fuzzy finder). Inspired by GitHub CLI.

USAGE:
    aws fzf [fzf-flags] <service> <resource> <action> [aws-options]

FZF FLAGS (specify before service):
    Any fzf flags can be passed before the service name. These are passed
    directly to fzf and extend the default options. Common examples:

    --tmux [position]         Open in tmux popup (default: center,50%,50%)
                              Position format: [position][,width[,height]]
                              Examples: "80%,80%", "center,50%,50%", "bottom"
    --height <n>              Set height (e.g., --height 50%)
    --multi                   Enable multi-select mode
    --border <style>          Set border style (e.g., --border rounded)
    --preview-window <opts>   Configure preview window
    --reverse                 Reverse layout

    See 'man fzf' for all available fzf options.

COMMANDS:
    Secrets Manager:
        aws fzf secret list                       Browse secrets

    Parameter Store:
        aws fzf param list                        Browse parameters

    S3:
        aws fzf s3 bucket list                    Browse S3 buckets
        aws fzf s3 object list --bucket <name>    Browse objects in bucket

    ECS:
        aws fzf ecs cluster list                  Browse ECS clusters
        aws fzf ecs service list --cluster <name> Browse services in cluster
        aws fzf ecs task list --cluster <name>    Browse tasks in cluster

    Lambda:
        aws fzf lambda list                       Browse Lambda functions

    CloudWatch Logs:
        aws fzf logs group list                   Browse log groups
        aws fzf logs stream list --log-group-name Browse log streams in group

    RDS:
        aws fzf rds instance list                 Browse RDS instances
        aws fzf rds cluster list                  Browse RDS Aurora clusters

    DSQL:
        aws fzf dsql cluster list                 Browse DSQL clusters

    DynamoDB:
        aws fzf dynamodb table list               Browse DynamoDB tables

    SSO:
        aws fzf sso profile list                  Browse and login to SSO profiles

AWS OPTIONS (specify after action):
    All AWS CLI options are supported and passed through:
    --region <region>       AWS region (overrides default)
    --profile <profile>     AWS profile (overrides default)

KEYBOARD SHORTCUTS:
    Common shortcuts (most commands):
    enter       View resource details
    ctrl-o      Open in AWS Console

    S3 Buckets:
    alt-enter   List objects

    Additional shortcuts (service-specific):
    ctrl-v      Get secret/parameter value (secret, param)
    alt-c       Copy resource name/ID
    alt-a       Copy resource ARN

EXAMPLES:
    # Basic usage (backward compatible)
    aws fzf secret list
    aws fzf param list --region us-west-2
    aws fzf s3 bucket list
    aws fzf s3 object list --bucket my-bucket

    # With fzf flags (new feature)
    aws fzf --tmux secret list                           # Open in tmux popup
    aws fzf --tmux center,80%,80% param list            # Custom popup size
    aws fzf --height 50% --border rounded secret list   # Custom height and border
    aws fzf --multi s3 bucket list                      # Multi-select mode

    # Combining fzf and AWS flags
    aws fzf --tmux --height 80% secret list --region us-west-2
    aws fzf --multi lambda list --profile prod
    aws fzf --height 90% ecs service list --cluster my-cluster

    # More examples
    aws fzf ecs cluster list
    aws fzf ecs task list --cluster my-cluster --desired-status RUNNING

DEPENDENCIES:
    Required: aws, fzf, jq, gum
    Optional: pbcopy/xclip/xsel/wl-copy (for clipboard support)

SEE ALSO:
    AWS CLI documentation: https://docs.aws.amazon.com/cli/
    fzf: https://github.com/junegunn/fzf
    gum: https://github.com/charmbracelet/gum
EOF
}

# main()
#
# Main entry point for aws fzf
#
# DESCRIPTION:
#   Processes command line arguments and dispatches to appropriate sub-commands.
#   Handles command routing for s3, params, secrets, and ecs commands, as well
#   as help requests and error cases.
#
# PARAMETERS:
#   $1 - Service name (s3|params|secrets|ecs|help|--help|-h)
#   $2 - Command (list-buckets|describe-parameters|etc.)
#   $@ - Additional options passed to AWS CLI
#
# RETURNS:
#   0   - Success (command executed successfully)
#   1   - Error (unknown command)
#   Exit code from sub-command if applicable
#
main() {
    local fzf_flags=()
    local service=""
    local service_args=()

    # Parse arguments: everything before service = fzf flags, everything after = service args
    while [[ $# -gt 0 ]]; do
        case "$1" in
        --help | -h | help)
            _show_root_help
            exit 0
            ;;
        lambda | param | secret | ecs | log | s3 | rds | dsql | dynamodb | sso)
            # Found the service, everything after this is service args
            service="$1"
            shift
            service_args=("$@")
            break
            ;;
        "")
            _show_root_help
            exit 0
            ;;
        *)
            # Before service, collect as fzf flags
            fzf_flags+=("$1")
            shift
            ;;
        esac
    done

    # Export fzf flags for aws_core.sh to use
    if [[ ${#fzf_flags[@]} -gt 0 ]]; then
        # Use printf %q to properly quote each element for safe eval
        export FZF_AWS_FLAGS="$(printf '%q ' "${fzf_flags[@]}")"
    fi

    # Dispatch to service with remaining args
    case $service in
    lambda)
        _aws_lambda_main "${service_args[@]}"
        ;;
    param)
        _aws_param_main "${service_args[@]}"
        ;;
    secret)
        _aws_secret_main "${service_args[@]}"
        ;;
    ecs)
        _aws_ecs_main "${service_args[@]}"
        ;;
    log)
        _aws_log_main "${service_args[@]}"
        ;;
    s3)
        _aws_s3_main "${service_args[@]}"
        ;;
    rds)
        _aws_rds_main "${service_args[@]}"
        ;;
    dsql)
        _aws_dsql_main "${service_args[@]}"
        ;;
    dynamodb)
        _aws_dynamodb_main "${service_args[@]}"
        ;;
    sso)
        _aws_sso_main "${service_args[@]}"
        ;;
    "")
        _show_root_help
        ;;
    *)
        gum log --level error "Unknown service '$service'"
        gum log --level info "Supported services: secret, param, s3, ecs, lambda, log, rds, dsql, dynamodb, sso"
        gum log --level info "Run 'aws fzf --help' for detailed usage information"
        exit 1
        ;;
    esac
}

main "$@"
